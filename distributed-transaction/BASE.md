# 5.3.1 可靠事件队列

2008 年，eBay 系统架构师 Dan Pritchett 在 ACM 发表了论文《Base: An Acid Alternative》[^1]。文中，作者基于实践总结出一种独立于 ACID 之外，通过引入消息队列和幂等来达成一致性目标的技术手段，并提出了“最终一致性”的概念。

从论文的名字可以看出，最终一致性的概念与 ACID 强一致性对立。因为 ACID 在英文中有的“酸”的含义，这个事务模型明显刻意拼凑成 BASE（BASE 在英文中有碱的含义）。有酸 vs 碱这个计算机浑然天成的梗加成，《Base: An Acid Alternative》论文被广泛传播，BASE 理论和最终一致性也被大家熟悉。


BASE 是 Basically Available，Soft state 和 Eventually consistent 的缩写，其核心理念为：

- 基本可用（Basically Available）：系统保证在大多数情况下能够提供服务，即使在某些节点出现故障时，系统仍会尽可能地保持可用。这意味着系统会优先保障可用性而非一致性。
- 柔性状态（Soft state）：系统状态允许在一段时间内处于不一致状态。与 ACID 的强一致性要求不同，BASE 允许系统在更新过程中状态是“柔性”的，即数据可以在某些节点上暂时不一致，直到系统最终达到一致性。
- 最终一致性（Eventually consistent）：系统在经过一段时间后会达到一致性。即使在网络分区或系统故障的情况下，数据最终会被同步到所有节点，保证最终的一致性。最终一致性强调的是系统在经过足够的时间和重复的数据同步操作后，所有节点的数据将会一致。

BASE 理论是对 CAP 定理中 AP（可用性和分区容错性）方案的延伸。强调在分布式系统中，即使无法做到强一致性，也可以通过适当的方式使系统达到最终一致性。

Dan Pritchett 在论文中提到的适当的方式，可以总结为基于可靠事件队列的事件驱动模式。该模式的关键在于确保事件的可靠投递和避免重复消费。幸运的是，当前流行的消息中间件已经普遍实现了事件持久化和至少一次投递机制。此外，幂等性的实现也有成熟的解决方案，因此这些问题已不再是难点。


下面，笔者以一个具体的例子帮助你理解“可靠事件队列”的具体做法。假设有一个电商系统，下单操作需要依赖三个服务：支付服务（银行扣款）、库存服务（扣减商品库存）、积分服务（为用户增加积分）。下单过程中，我们优先处理最核心、风险最高的服务，即按照支付扣款 -> 仓库出库 -> 为用户增加积分的顺序执行。下单的整个流程如图 6-2 所示。

:::center
  ![](../assets/BASE.svg)<br/>
  图 5-2 可靠事件队列模型
:::

用户向商店发送了一个交易请求，比如购买一件价值 ￥100 的商品。支付服务首先创建一个本地的扣款事务，如果扣款成功，系统将在消息队列中新增一条待处理消息。消息的大致结构如下：

```go
struct Message {
	事务 ID;
	扣款 ￥100（状态：已完成）;
	仓库出库（状态：待处理）;
	赠送积分（状态：待处理）
}
```
系统有一个持续运行服务定时轮询消息队列，检查是否有待处理的消息。如果有，则通知库存服务和积分服务进行相应处理。

此时，可能会出现以下几种情况：

- 仓库服务和积分服务顺利完成任务：两者成功完成出库和积分操作，并将结果反馈给支付服务。支付服务随后将消息状态更新为“已完成”，整个事务顺利完成，实现最终一致性。
- 网络问题导致消息未送达：仓库服务或积分服务由于网络问题未收到支付服务的消息。此时，支付服务中的消息状态会保持为“待处理”，消息服务将在每次轮询时继续向未响应的服务节点**重复**发送消息，此过程将持续到通信恢复正常为止。重复消息的操作要求所有接收消息的服务具备幂等性（幂等性设计详见 5.4 节），从而确保出库和积分操作仅被执行一次。
- 服务无法完成操作：如果仓库服务或积分服务由于某种原因无法完成处理。例如，仓库库存不足，消息服务依然持续发送消息，直到操作成功（如库存补充）或由人工介入终止。

由此可见，在可靠消息队列方案中，一旦第一步扣款成功，后续操作就没有失败回滚的概念，只有成功的选项。

以上这种依靠持续重试来保证可靠性的解决方案在计算机的其他领域中也被频繁使用，它还有专有的名称 —— “最大努力交付（Best-Effort Delivery）”。可靠事件队列还有一种更普遍的形式，被称为“最大努力一次提交（Best-Effort 1PC）”，指的是将最有可能出错的业务以本地事务的方式完成后，采用不断重试的方式来促使同一个分布式事务中其他关联的业务全部完成。

[^1]: 参见 https://queue.acm.org/detail.cfm?id=1394128
