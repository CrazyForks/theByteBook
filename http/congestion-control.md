# 2.6.1 网络拥塞控制原理

## 1. 网络拥塞的产生与控制逻辑

Google 曾在 ACM 杂志上发布过一篇论文《BBR: Congestion-Based Congestion Control》，论文主要介绍了 BBR 算法的设计，内容中一张配图（图 2-22）形象说明了网络拥塞的产生和控制逻辑。

:::center
  ![](../assets/bbr-cc.png)<br/>
 图 2-22 网络拥塞的产生和控制逻辑
:::

图中有几个网络拥塞控制的相关术语，它们的解释如下：

- RTprop (round-trip propagation time，两个节点之间最小时延)：该时延取决于物理距离，物理距离越长，节点之间时延越大。
- BtlBw（bottleneck bandwidth，瓶颈带宽）：如果把网络链路想象成水管，RTprop 就是水管的长度，BtlBw 则是水管最窄处的直径。
- BDP（bandwidth-delay product，带宽和延迟的乘积）：它代表了网络上能够同时容纳的数据量（水管中有多少流动的水）。 BDP 的计算公式是：BDP = 带宽 × 延迟。其中，带宽以比特每秒（bps）为单位，延迟以秒为单位。
- inflight 数据：指已经发送出去但尚未收到确认的数据包。这些数据包仍在网络中传输，等待接收方的处理或确认。

图 2-22 中的横轴表示 inflight 数据量，它根据 RTT 与 传输速率，分成了三个区间:

1. (0，BDP): 称为应用受限区（app limited），这个区间内，inflight 数据量并未占满瓶颈带宽。
2. (BDP，BtlneckBuffSize)： 称为带宽受限区（bandwidth limited），这个区间内，inflight 数据量已经达到链路瓶颈容量，但还未超过 瓶颈容量+缓冲区容量，此时应用能发送的数据量主要受带宽限制。
3. (BDP + BtlneckBuffSize，infinity) ：称为缓冲区受限区（buffer limited），这个区间内，实际发送速率已经超过瓶颈容量+缓冲区容量 ，多出来的数据会被丢弃，即产生了丢包。

通过分析图中各网络属性的关系，可以看出，**拥塞是 inflight 数据量持续向右侧偏离 BDP 线的行为，而拥塞控制就是控制 inflight 数据量偏离 BDP 线程度的方案或算法**。

## 2. 初代拥塞控制目标旨在收敛

早期互联网以丢包为控制条件的拥塞控制。如图 2-21 所示，这一时期的拥塞控制算法首先是慢启动（Slow Start），当出现丢包时，进行拥塞避免（Congestion Avoiance），丢包不再出现时，再进行慢启动，如此一直反复。

:::center
  ![](../assets/cc.png)<br/>
 图 2-21 早期以丢包为条件的拥塞控制
:::

以丢包为控制条件的机制完美适应了早期互联网特征：**低带宽、浅缓存队列**。但随着移动互联网大爆发，多媒体应用特别是图片、音视频类促使带宽猛增，而摩尔定律促使各类趋于廉价、同时性能大幅提升。当路由/网关设备缓存队列猛增、链路变长变宽时，初代的**以丢包为控制条件的拥塞控制**就不再不适用了。


## 3. 现代拥塞控制目标旨在网络效能最大化

如果说初代的拥塞控制目标旨在收敛，防止互联网服务产生“拥塞崩溃”，那么这一次 BBR 的目标则旨在**充分利用链路带宽、路由/网关设备的缓存队列，使网络效能最大化**。


网络效能最大化的本质是寻找网络传输中的最优点。图 2-22 内所示的两个黑色的圆圈即为网络传输最优点：
- 上面的圆圈为 min RTT（延迟极小值），网络链路中 Buffer 未沾满，没有任何丢包情况;
- 下面圆圈的为 max BW（带宽极大值），网络链路中的 Buffer 被充分利用。

当网络传输处于最优点时：

- 数据包投递率 = BtlBW（瓶颈带宽），保证了瓶颈链路被 100% 利用；
- 在途数据包总数 = BDP（时延带宽积），保证未占用 Buffer。


然而，延迟极小值和带宽极大值互相悖论，无法同时测得。

如图 2-24 所示，要测量最大带宽，就要把瓶颈链路填满，此时 buffer 中有一定量的数据包，影响延迟指标。要测量最低延迟，就要保证 buffer 为空，此时就无法测量最大带宽值。

:::center
  ![](../assets/bbr-2.png)<br/>
 图 2-24 无法同时得到 max BW 和 min RTT
:::

## 3. BBR 的解题思路以及状态机设计

BBR 的解题思路是不再考虑丢包作为拥塞的判断条件，而是交替测量带宽和延迟，用一段时间内的带宽极大值和延迟极小值，作为计算发包速率的估计值。

**BBR 将拥塞控制时机提前，不再等到丢包时再进行暴力限制，而是控制稳定的发包速度，尽量榨干带宽，却又不让数据在中间设备的缓存队列上累积**：

- 为了榨干带宽，BBR 会周期性地探测链路条件是否变好了，如果是，则加大发送速率；
- 为了不让数据在中间设备的缓存队列上累积，BBR 会周期性地探测链路的最小 RTT，并使用最小 RTT 计算发包速率。

BBR 拥塞控制状态机是实现以上思路的基础。BBR 的拥塞控制状态机任一时刻都是处于以下四个状态之一：启动（STARTUP）、排空（DRAIN）、带宽探测（PROBE_ BW）和时延探测（PROBE_RTT），它们之间的关系如图 2-23 所示 。

- 启动阶段（STARTUP）：当连接建立时，BBR 采用传统拥塞控制算法慢启动方式，指数级增加发送速率，目的是尽可能快的探测到带宽极大值。当判断连续时间内发送速率不再增长时，说明已到达瓶颈带宽，此时状态切换至排空阶段。
- 排空阶段（DRAIN）：该阶段指数级降低发送速率，相当于启动阶段的逆过程，目的是将多占的 Buffer 慢慢排空。
- 完成以上两个阶段后，BBR 进入带宽探测阶段（PROBE_ BW），BBR 大部分时间都在该状态运行。当 BBR 测量到带宽极大值和延迟极小值，并且网络中在途数据包 inflight[^3] 等于 BDP 时，便开始以一个稳定的匀速维护着网络状态，偶尔小幅提速探测是否有更大带宽，偶尔小幅降速公平的让出部分带宽。
- 时延探测阶段（Probe RTT）：如果估计延迟不变(未测量到比上周期最小 RTT 更小值)，就进入延迟探测阶段。该状态下，拥塞窗口 Cwnd 被设置为 4 个 MSS（Maximum Segment Size，最大报文长度），并对 RTT 重新测量，持续 200ms，超时后，根据网络带宽是否满载决定状态切换为启动阶段或带宽探测阶段。


:::center
  ![](../assets/bbr-status.png)<br/>
 图 2-23 BBR 状态转移关系
:::

