# 2.8.1 QUIC 设计原理

QUIC 出现之前，HTTP 使用 TCP 作为传输数据的底层协议。然而，作为一个 40 年前开发的传输层通信协议，肯定没有想到今天移动设备盛行的场景。

在如今复杂的移动网络环境下，TCP 存在着先天的设计缺陷，这些问题集中在以下几点：

- 建立连接时握手延迟大：HTTPS 握手**初次连接至少需要 3 个 RTT** 才能建立。
- 队头阻塞问题：以 HTTP/2 为例，多个数据请求在同一个 TCP 连接上所有 stream（流，HTTP/2 传输的数据单元）都**必须按顺序处理**。如果一个 stream 的数据丢失，后面其他的 stream 将被阻塞，直到丢失的数据被重传。
- TCP 协议僵化问题：作为一个运行了接近 40 多年的协议，许多中间件（例如防火墙和路由器）**已经变得依赖于某些隐式规则**，打补丁或者说推动 TCP 协议更新脱离现实。

在汲取 TCP 的设计经验以及现在的网络环境因素影响，QUIC 通过 QUIC 实现了一种全新的可靠性传输机制，具有更低的延迟和更高的吞吐量。下面列举 QUIC 的部分重要特性，这些特性是 QUIC 被寄予厚望的关键。

## 1. 支持连接迁移

当用户网络环境发生变化，这在移动端相当普遍，例如 WIFI 切换到 4G 时，TCP 基于四元组的方式无法保持连接的存活。而 **QUIC 由于使用 Connection ID 标识连接**，当源地址发生改变时，连接不受环境变化影响，因此 QUIC 可以实现网络变化的无缝切换，从而保证连接存活和数据正常收发。

:::center
  ![](../assets/quic-connection.png)<br/>
 图 2-27 QUIC 支持连接迁移
:::

## 2. 低时延连接

以一个 HTTPS 的请求为例，即使是最新的 TLS 1.3 协议，**初次连接也至少需要 2-RTT 才能开启数据传输**，像 TCP Fastopen 这类补丁方案，由于协议僵化原因，根本不会在复杂网络中起到作用。

QUIC 内部集成了 TLS 安全协议，无需像 TCP 那样，先经过三次握手，再经过 TLS 握手才开启数据传输。**QUIC 初次连接只需要 1- RTT 就能开启数据传输**。

:::center
  ![](../assets/quic-handshake.png)<br/>
 图 2-28 不同协议开启数据传输时，需要的 RTT数
:::

## 3. 可插拔拥塞控制

笔者曾在工作中推进升级 TCP 拥塞控制算法，过程相当艰难，原因就是要升级系统内核。

大多数 QUIC 实现是在用户空间完成，因此支持“可插拔”的 Cubic、BBR、PCC 等拥塞控制算法。这意味着工程师们不关心内核或者不用深入了解内核的开发，就可以灵活地调整可靠传输机制和拥塞控制算法等。例如，Cloudflare 开发的 QUIC 开源实现 quiche，调用它的 setSendAlgorithm 方法，就能跨过内核，灵活控制使用的拥塞控制算法。

## 4. 降低对丢包的敏感度

先来看 HTTP/2 Stream 的处理，如图 2-29 所示，如果一个属于 Stream2 的 TCP 数据包丢失了（图中标 5 的圆圈），那么它将阻塞后续数据包的传输。这也就是我们常说的“队头阻塞问题”（head-of-line blocking）。

而 QUIC 为每个 Stream 设计了单独控制，Stream 之间没有顺序依赖。这意味着，如果一个属于 Stream2 的 UDP 数据包丢失了，它只会影响 Stream2 的处理，不会阻塞 Stream1 和 Stream3 的传输。这样的好处是，完全避免 TCP 协议出现的队头阻塞问题。

:::center
  ![](../assets/quic-head-block.png)<br/>
 图 2-29 QUIC Stream 的设计减小了丢包的影响
:::

此外，还要提及 QUIC 实现的另外一个特性 —— QPACK。QPACK 通过更高效的头部压缩技术减少网络传输中的冗余数据量，这种压缩机制不仅提升了数据传输的效率，也有助于缓解上述的“队头阻塞问题”。

这样，通过全方位无死角的优化设计，保证了 QUIC 在当今网络环境下比 TCP 更安全、更快速的连接、更高的传输效率。


