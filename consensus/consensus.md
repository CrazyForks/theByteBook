# 6.1 什么是共识

讨论 Paxos 或 Raft 时，很多文献使用“分布式一致性协议”或“分布式一致性算法”来描述这些技术。例如，Google Chubby 系统的作者 Mike Burrows 曾评价 Paxos：“There is only one consensus protocol...”，这一句话常被翻译为“世界上只有一种一致性算法”。

尽管“共识”和“一致”在汉语中含义相近，但在计算机领域，这两个术语具有截然不同的含义：

- 共识（Consensus）：指所有节点就某项操作（如选主、原子事务提交、日志复制、分布式锁管理等）达成一致的过程及其算法。
- 一致性（Consistency）：描述多个节点的数据是否保持一致，关注数据最终达到稳定状态的结果。

因此，Paxos、Raft 和 ZAB 等算法应归类为“共识”算法，而 CAP 定理中的 C 和数据库 ACID 模型中的 C 则描述的是“一致性”问题。将 Paxos 等算法称为“共识算法”更为准确。

在分布式系统中，节点故障是不可避免的。为提高系统可靠性，可以通过增加节点数量，依据“少数服从多数”的原则确保系统在多数节点（n/2+1）正常工作的情况下仍能达成决策。这种通过多数节点（Quorum）保证系统容错性的机制被称为 Quorum 机制。

:::tip Quorum 机制

Quorum 机制下，一个 N/2+1 节点个数的集群最多容忍 ⌊N/2⌋ 个节点失效。例如：
- 3 节点集群：Quorum 为 2，允许 1 个节点失效；
- 5 节点集群：Quorum 为 3，允许 2 个节点失效。

相应的，5 个节点的集群，即至少 3 个节点参与决策，才能达成 Quorum。

:::

根据上述的讨论，以 Quorum 为基础，在充满不确定的环境下（如节点故障、网络不可靠、消息延迟或丢失），仍然能够协商出一致的决策，从而对外呈现出一致的运行结果，这个过程称为节点间”协商共识“。

一旦解决了共识问题，就能为分布式应用提供一套屏蔽内部复杂问题的抽象机制，为应用层提供一致性保证，满足多种目标需求，例如：
- **主节点选举**：对于一个主从复制的数据库，所有的节点需要就“谁来当主节点”达成一致。如果由于网络问题出现节点间无法通信，很容易出现争议（也就是没有形成共识）。不解决争议问题，就会出现多个节点同时认为自己是主节点，也就是出现分布式系统中最头疼的情况 —— “脑裂”。
- **原子事务提交**：对于支持跨节点或者跨分区事务的数据库，可能会出现这样的情况：某些节点事务执行成功，某些节点事务执行失败。为了维护事务的原子性（即 ACID 特性），所有节点必须就事务的结果达成一致。
- **分布式锁管理**：当多个请求尝试访问共享资源时，共识机制确保所有节点一致认定“谁成功获取锁”。即使出现网络故障或节点异常，也能避免加锁争议，防止并发冲突或数据不一致。
- **日志复制**：日志复制是指将主节点的“操作日志”复制到从节点。日志条目的顺序必须在所有节点上形成一致，即日志条目需要按相同的顺序被写入（“顺序”相当重要，笔者将在下一节介绍）。


[^2]: Lamport 在分布式系统理论方面有非常多的成就，比如 Lamport 时钟、拜占庭将军问题、Paxos 算法等等。除了计算机领域之外，其他领域的无数科研工作者也要成天和 Lamport 开发的一套软件打交道，目前科研行业应用最广泛的论文排版系统 —— LaTeX (名字中的 La 就是指 Lamport)