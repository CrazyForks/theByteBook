# 6.4.1 领导者选举

Paxos 算法中“节点众生平等”，每个节点都可以并行的发起提案。并行的发起提案，是导致活锁、以及其他异常问题的主要原因。那如何不破坏 Paxos 的“节点众生平等”基本原则，又能在提案节点中实现主次之分，限制每个节点都有不受控的提案权利？

Raft 对此的改进是明确领导者角色，增加选举机制分享提案权利。Raft 算法中，节点分为以下三种角色：

- **Leader（领导者）**：负责处理所有客户端请求，将请求转换为“日志”复制到其他节点，确保日志在多数节点（Quorum）上被提交并生效。其次，定期向所有节点发送心跳，维持自己的领导地位。
- **Follower（跟随者）**：接收 Leader 发送的日志条目，确认日志条目的写入情况，并向 Leader 发送响应。
- **Candidate（候选人）**：过渡角色 Candidate，Leader 丧失时，Follower 会转为 Candidate 参与选举；


联想到现实世界中的领导人都有一段不等的任期。自然，Raft 中的 Leader 也对应的概念 —— term。任期是一个递增的数字，每次选举都会增加。

- 任期越大，话语权越大：本地任期较小的总是服从任期更高的消息来源。
- 每次选举，任期都会 +1：确保不会在多个选举过程中计票混乱。
- 高任期的节点收到低任期节点的任何请求时，会直接拒绝。

也就是说，任期是第一优先级。任期最大的节点内数据一定是最新的、最全的，最有资格成为 Leader 代表集群状态。

:::center
  ![](../assets/raft-term.svg)
  图 6-11 Raft 通过任期的概念来分隔时间，每个任期开始都会进行一次领导者选举
:::

图 6-12 概述了 Raft 集群 Leader 选举过程。跟随者在“选举超时”之内没有收到领导者的心跳，它将自己的任期号加一转变为候选者状态，其他节点广播“请给自己投票”的消息（RequestVote RPC），发起新一轮的选举：

- **选举超时**：在固定时间内未收到其他节点的响应，或者收到的响应（同意票）的节点数量未达到 Quorum N/2+1 的要求。此时，触发选举超时进入下一轮选举；
- **选举失败**：选举过程中，收到 Leader 心跳，或者发现有更高的 term，说明有新任期的 Leader，结束结束当前的选举。
- **选举成功**：选举过程中，收到的响应节点的数量达到 Quorum 要求，选举成功成为集群的 Leader。之后，Leader 周期性的向所有节点发送心跳包来维持自己的权威。

:::center
  ![](../assets/raft-election.svg)
  图 6-12 Raft 选举过程
:::

在 Paxos 的选举过程中，常常会出现未达到指定票数而需要重新选举的情况。Raft 算法也面临类似的问题，但 Raft 巧妙地引入随机选举超时时间，通过将超时时间分散开来，Raft 保证大多数情况下只有一个服务器节点会先发起选举，而不是多个节点同时发起选举，这样就能减少了因选票分散导致选举失败的概率：
- 跟随者等待领导者心跳超时的时间间隔，是随机的；
- 如果候选人在一个随机时间间隔内，没有赢得过半票数，那么选举无效了，然后候选人发起新一轮的选举，也就是说，等待选举超时的时间间隔，也是随机的。

使用 Quorum 机制选举出的 Leader 便代表了整个集群的意志。现在，你思考：“代表集群意志的 Leader 发起提案，是否还需要 Paxos 第一轮中 “准备阶段” 呢？”。





