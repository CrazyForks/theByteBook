# 6.4.1 领导者选举

Raft 是一个强领导者算法。

Raft 算法中，节点有三种角色，并且可以互相转换：

- **领导者（Leader）**：接收 client（客户端）的所有请求，Raft 算法中所有的操作以 Leader 为准。Leader 平常的工作包括 3 个部分：处理写请求、管理日志复制、不断发送心跳信息通知其他节点”我是 Leader，我还活者，你们现在不要发起新的选举“；
- **Follower（跟随者）**：相当于普通群众，被动接收和处理来自 Leader 的消息。当 Leader 心跳超时时，就主动站出来，变成“候选人”；
- **Candidate（候选人）**：用于选举出一个新的 Leader。Candidate 向其他节点发送投票（RequestVote RPC）消息，通知其他节点来投票，如果赢得大多数选票，就升级为 Leader。



Raft 将整个系统的时间划分为一个个独立的“任期”（term）。每个 term 由单调递增的数字（任期编号）标识**

- 任期越大，话语权越大：本地任期较小的总是服从任期更好的消息来源。
- 每次选举，任期都会 +1：确保不会在多个选举过程中计票混乱。
- 高任期的节点收到低任期节点的任何请求时，会直接拒绝。

节点进行“交流”（RPC 通信）时，任期是第一优先级的，只有对齐了任期，才有谈其他的基础。

简单来说，任期标明了 Leader 的服役阶段。保证在某些极端的情况下最终只有一个 Leader，例如下面两种情况：



:::center
  ![](../assets/raft-term.svg)
  图 6-15 Raft term 与成员状态变更
:::


每个 Follower 在本地维持一个选举时钟，选举时钟到期时，如果没有收到 Leader 的日志或者心跳，那么就开始发起选举。

投票消息（RequestVote RPC）的结构大致如下：

```json
{
  "term": 5,
  "candidateId": "candidate-123",
  "lastLogIndex": 10,
  "lastLogTerm": 4
}
```

图 6-16 概述了 Raft 集群 Leader 选举过程。会发生下面的情况：

- **选举超时**：在固定时间内未收到其他节点的响应，或者收到的响应（同意票）的节点数量未达到 Quorum N/2+1 的要求。此时，触发选举超时进入下一轮选举；
- **选举成功**：选举过程中，收到的响应节点的数量达到 Quorum 要求，选举成功，该节点成为集群的 Leader；
- **选举失败**：选举过程中，收到 Leader 心跳，或者发现有更高的 term，说明有新任期的 Leader，结束结束当前的选举。


:::center
  ![](../assets/raft-election.svg)
  图 6-16 Raft 选举过程
:::




	





