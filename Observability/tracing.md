# 9.3.3 分布式链路追踪

微服务架构的先驱 Uber，曾经在公开的资料中介绍过他们的微服务架构的规模，整个系统大约有 2,200 个服务互相依赖，引用资料中的配图，感受扑面而来的复杂。

:::center
  ![](../assets/uber-microservice.png)<br/>
  图 9-17 Uber 使用 Jaeger 生成的追踪链路拓扑 [图片来源](https://www.uber.com/en-IN/blog/microservice-architecture/)
:::

上述各个子服务可能由不同团队开发、使用不同编程语言实现，并部署在数千台服务器上，横跨多个数据中心。因此，理解复杂系统行为并分析性能问题的需求变得尤为迫切。

2010年4月，Google 的工程师们总结了他们在治理分布式系统中的经验，发表了论文《Dapper, a Large-Scale Distributed Systems Tracing Infrastructure》[^1]。论文中详细阐述了 Google 内部分布式链路追踪系统 Dapper 的设计理念，其核心原理是将一次分布式请求还原成调用链路，对请求的调用情况集中展示，比如各个服务节点上的耗时、请求具体到达哪台机器上、每个服务节点的请求状态等等。

## 1. Trace 和 Span

Dapper 论文中提出了后来成为链路追踪系统设计共识的两个术语：Trace（追踪）和 Span（跨度）：
- Trace 是一个完整的请求过程的集合。它代表了一个用户请求在系统中从开始到结束的整个生命周期，涵盖了该请求经过的所有服务和组件。一个 Trace 包含多个 Span，所有这些 Span 共同记录了这个请求的执行路径；
- Span 是 Trace 中的一个基本单元。它表示某一具体操作的执行，例如一个服务调用、数据库查询或其他子操作。每个 Span 都有一个唯一标识符，并包含有关该操作的详细信息，如开始时间、持续时间、操作类型和相关的元数据。Span 还可以嵌套，表示父子关系，帮助理解分布式系统中不同组件之间的依赖关系。

每一条 Trace 记录，实际上都是由若干个有顺序、有层级关系的 Span 所组成一颗“追踪树”（Trace Tree），如图 9-18 所示。

:::center
  ![](../assets/Dapper-trace-span.png)<br/>
  图 9-18 Trace 和 Spans
:::

总结 Dapper 原理就是在分布式应用的接口方法中设置一些观察点，在入口节点给每个请求分配一个全局唯一的标识 TraceId，当请求流经这些观察点时就会记录一条对应的链路日志（Span），最后通过 TraceId 将一次请求的所有链路日志进行组装，还原出该次请求的链路轨迹。如此，我们就能：

- 故障快速定位：可以通过调用链结合业务日志快速定位错误信息。
- 链路性能可视化：各个阶段链路耗时、服务依赖关系可以通过可视化界面展现出来。
- 链路分析：通过分析链路耗时、服务依赖关系可以得到用户的行为路径，汇总分析应用在很多业务场景。

图 9-19 展示了 Skywalking 链路分析，根据拓扑图中 Span 记录的时间信息和响应结果，我们可以很容易定位到出错或者缓慢的服务。
:::center
  ![](../assets/skywalking-ui.jpeg)<br/>
  图 9-19 Skywalking 链路分析
:::

## 2. 追踪技术的核心

由于链路追踪需要深入获取内部信息，不可避免地会侵入业务逻辑代码中。而微服务架构本身已经集成了多种服务治理逻辑，再加入链路追踪逻辑必然进一步加剧其复杂性。因此，Dapper 论文提出的链路追踪系统的设计原则必须满足以下两个关键条件：

- 应用级透明：开发者不需要修改业务代码或者仅需要极少的修改即可实现埋点，这意味着追踪逻辑对应用层不可见或者几乎不可见。
- 低开销：埋点操作对系统的性能影响应当尽可能小，以避免追踪逻辑本身成为系统性能的瓶颈。

目前市场上常见的链路追踪系统 Zipkin、Skywalking、Pinpoint 等，它们都是基于服务追踪实现的。服务追踪的实现思路是通过某些手段给目标应用注入追踪探针（Probe），针对 Java 应用一般就是通过 Java Agent 注入的。探针在结构上可视为一个寄生在目标服务身上的小型微服务系统，它一般会有自己专用的服务注册、心跳检测等功能，有专门的数据收集协议，把从目标系统中监控得到的服务调用信息，通过另一次独立的 HTTP 或者 RPC 请求发送给追踪系统。


除了注入追踪探针的方案外，还有基于边车代理的追踪方式，这是服务网格中的专属方案，也是理想的分布式追踪模型：
- 边车代理对应用完全透明：有自己独立数据通道，追踪数据通过控制平面上报，不会有任何依赖和干扰；
- 与程序语言无法：无论应用采用什么编程语言，只要它通过网络（如 HTTP 或 gRPC）访问服务，就可以被追踪到。

目前，市场占有率最高 Sidecar 实现 Envoy 就提供了链路追踪数据采集功能。如果系统中使用服务网格 Istio，简单配置下，就能收集到服务间的追踪链路信息，并将其转发到 Prometheus、Jaeger 或其他兼容的后端。

## 3. 代表性项目

受 Dapper 思想和协议的影响，市场上开始出现大量的链路追踪项目。

最开始是 Twitter 受到 Dapper 的启发，开发了自己的分布式追踪系统 Zipkin，Zipkin 是第一个被广泛采用的开源的分布式链路追踪系统，提供了数据收集（提供了 Java、Python、Go 等多种 SDK）、存储（如 Elasticsearch、Cassandra 和 MySQL）和查询的功能以及友好的 UI 界面来展示追踪信息。2017 年 Uber 在基于 Zipkin 思想和经验的基础上开源了 Jaeger，增加了自适应采样、提供了更加强大和灵活的查询能力等。

除以上两个项目外，国内的工程师应该非常熟悉 Skywalking，这是一款本土开源应用性能监控（APM）工具，它不仅支持分布式链路追踪，还涵盖应用性能监控、日志分析等多个方面。

:::center
  ![](../assets/tracing.png)<br/>
  图 9-19 CNCF 下分布式链路追踪产品生态
:::



[^1]: 参见《Dapper, a Large-Scale Distributed Systems Tracing Infrastructure》https://research.google/pubs/dapper-a-large-scale-distributed-systems-tracing-infrastructure/
