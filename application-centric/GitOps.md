# 10.6 应用的交付与部署

IaD 的思想还衍生出一种 CI/CD（持续集成/持续交付）和自动化运维的实践方法。解释 GitOps 的工作原理之前，我们先来看一个传统的 CI/CD 流程。

图 10-1 所示的 CI/CD 流程包括以下步骤：开发人员提交代码，触发 Jenkins 构建任务；使用 SonarQube 进行代码质量检测；通过 Docker 构建镜像并推送至镜像仓库；使用 Helm 打包服务配置；最终将应用部署到 Kubernetes 集群。

:::center
  ![](../assets/cicd-push.png)<br/>
  图 10-1 Push 交付模型
:::

虽然上述流程实现了自动化，表面上看也没什么问题。但认真观察，上述流程都是从左往右推进，时间长了，容易发生“配置漂移”，即难以保证期望状态与实际运行状态一致。此外，流程中仍然存在人工干预环节，例如手动操作 kubectl，这将导致难以追溯和无法回滚等安全合规问题。


GitOps 的概念最早由 Weaveworks 公司与 2017年 提出，它的核心理念是以 Git 仓库为“单一事实来源”（Single Source of Truth），通过声明式配置和自动化同步机制来管理和部署应用。通过图 观察 GitOps 下的 CI/CD 流程

- 团队成员首先 fork 仓库并进行业务逻辑开发，完成后提交 Pull Request。
- 随后，CI 流水线被触发，执行一系列任务，如校验配置文件、运行自动化测试、构建镜像并推送到镜像仓库。
- 当 CI 流水线成功完成后，具备合并权限的人员将 Pull Request 合并至主分支。
- 合并事件进一步触发 CD 流水线，CD 系统（例如 Argo CD）自动将变应用至目标 Kubernetes 集群。

:::center
  ![](../assets/gitops-workflow.webp)<br/>
  图 10-3 GitOps 下的 CI/CD 流程
:::

不难看出，GitOps 可以看作是 IaD 思想的延伸。IaD 强调将基础设施配置存储在一个可变更和版本化的数据源中。在 GitOps 中，所有基础设施和应用配置都保存在 Git 仓库中，基础设施管理和应用部署的控制权交由 Git。每次配置更改都会被记录和版本化，历史版本可随时恢复，同时每一次操作都能追溯。

以 Git 作为系统配置的“单一事实来源”（Single Source of Truth），加上 Argo CD 这种自动同步的系统，那么就能：

- **回滚更快速**：
Argo CD 会定期拉取最新配置并将其应用到集群中。如果新提交的配置引发应用故障，可以通过 Git 历史快速回滚到之前的可用状态。
- **集群灾备更简单**：例如，当某个可用区的 Kubernetes 集群发生故障且短期内无法恢复时，可以直接创建一个新集群，并将 Argo CD 关联到对应的 Git 仓库。新集群会自动同步仓库中的所有应用配置声明，全程无需人工干预。
- **更合规、更安全**：通过 Git 实现操作控制，开发人员提交 Pull Request，管理人员审核并合并（Merge Request），无需额外的权限管理系统。Argo CD 运行于 Kubernetes 集群内，并已配置所需的访问权限。除集群管理员和少数授权人员外，其余人员无需直接访问 Kubernetes 集群，无需额外分发证书或配置权限，整个集群更安全、更合规。