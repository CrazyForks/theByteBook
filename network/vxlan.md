# 3.6.4 Overlay 网络通信 VXLAN 

有了各类虚拟设备之后，下一步就是利用这些设备实现不同容器间的网络互联。容器网络模型多数属于 Overlay 网络，所以本节笔者以 Linux 内核中的 VXLAN 模块为例，介绍 Overlay 网络的通信原理。

:::tip 什么是 Overlay 网络
Overlay 网络是通过封装技术将数据包封装在另一个数据包中，从而在现有物理网络（相对 Overlay，称为 Underlay 网络）之上创建一个逻辑网络。不同物理位置的虚拟机、容器、节点通过 Overlay 技术组网之后，它们之间的通信就像在一个局域网内一样。

Overlay 网络计算机系统中是一个应用非常广泛的技术，例如 3.5.3 节介绍的 RoCE，第四章负载均衡介绍的 GRE、IPIP 都属于 Overlay 网络技术。
:::

:::center
  ![](../assets/overlay.svg)<br/>
  图 3-24 Overlay 与 Underlay 网络模型
:::

## 1. 虚拟局域网 VLAN

VXLAN 你可能没有听说过，但 VLAN（Virtual Local Area Network，虚拟局域网）相信只要从事计算机行业的人都有所了解。早在 1995 年，IEEE 就发表了 802.1Q 标准定义了在以太网数据帧中 VLAN 的格式，并且沿用至今。

由于二层网络本身特性决定它非常依赖广播，但当设备非常多，广播又非常频繁的时候，很容易形成广播风暴。因此 VLAN 的首要职责是划分广播域，将同一个物理网络的设备区分出来。VLAN 的做法是在以太网的报头增加 VLAN tag，让所有广播只针对相同的 VLAN tag 的设备生效，也就是将物理网络划分为多个子网，这样就缩小了广播域，也提高了安全性和可管理性。

不过 VLAN 有一个非常明显的缺陷，就是 VLAN tag 长度限制，当时的网络工程师完全未料及云计算会发展得会如此普及，只设计了 12 位来存储 VLAN ID，导致一个 VLAN 子网内的设备数量局限在 4000 个左右，这显然无法支持大型数据中心数以万计的设备数。

其次，虚拟化技术成熟之后，虚拟机的动态迁移变成常态化。为了保证迁移时业务不中断，就要求在虚拟机迁移时，不仅虚拟机的 IP 地址不变，而且虚拟机的运行状态也必须保持原状，所以虚拟机的动态迁移只能在同一个二层域中进行，而不能跨二层域迁移。

为了解决上述 VLAN 的设计缺陷，IETF 又重新定义了 VXLAN（Virtual eXtensible Local Area Network，虚拟可扩展局域网） 规范。

## 2. 虚拟可扩展局域网 VXLAN

从名字上看，VXLAN 像是 VLAN 的一种扩展协议，但其实 VXLAN 的设计与 VLAN 有着本质的不同。VXLAN 属于三层虚拟化网络（Network Virtualization over Layer 3，NVO3）的标准技术规范之一，**它实际是一种隧道封装技术，它使用 TCP/IP 协议栈的惯用手法“封装/解封装技术”，将 L2 的以太网帧封装成 L4 的 UDP 报文，然后在 L3 的网络中传输，效果就像 L2 的以太网帧在一个广播域中传输一样，不再受数据中心二层网络传输的限制**。

:::center
  ![](../assets/vxlan-data.png)<br/>
  图 3-25 VXLAN 报文结构
:::


在 VXLAN 隧道网络中，负责“封装/解封”的设备称为 VTEP 设备（VXLAN Tunnel Endpoints，VXLAN 隧道端点），它在 Linux 系统中通常表现为一个虚拟的网络接口。

使用 VXLAN 技术构建一个隧道网络之后，每个节点都会部署了一个 VETP 设备，当源服务器内的虚拟机发出原始数据帧后，在 VTEP 设备中被封装成 VXLAN 格式的报文，并通过宿主机的 IP 网络传递到隧道另一头的 VTEP 设备，目标服务器的 VETP 设备对 VXLAN 报文解封，得到原始的数据帧，最后转发至目标服务器内的某一台虚拟机。

:::center
  ![](../assets/VXLAN.png)<br/>
  图 3-26 VXLAN 通信概览
:::

从上述，我们看到 VXLAN 完美地弥补了 VLAN 的不足：
- 一方面通过 VXLAN 中的 24 比特 VNI 字段（如图 3-25 所示）提供多达 16M 租户的标识能力，远大于 VLAN 的 4000；
- 另一方面，VXLAN 本质上在两台交换机之间构建了一条穿越数据中心基础 IP 网络的虚拟隧道，将数据中心网络虚拟成一个巨型“二层交换机”，使虚拟机可以在不同子网之间动态迁移。

从 Linux 内核 3.12 版本起，Linux 对 VXLAN 有了完备的支持，只要三层可达的网络，不需要专门的硬件，简单的配置下 Linux 系统，就可以部署基于 VXLAN 的隧道网络。

VXLAN 因其具有很高的灵活性、扩展性和可管理性，也已经成为当前构建数据中心的主流技术，绝大多数公有云的 VPC（Virtual Private Cloud，虚拟私有云）都是用 VXLAN 技术在一个大二层网络上构建。