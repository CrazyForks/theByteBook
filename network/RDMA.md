# 3.4.3 远程直接内存访问 RDMA

尽管现代数据中心在硬件层面提供了足够的带宽（如普遍部署了 100G 交换机），但与之配套的底层通信协议的性能却并未跟上。传统的以太网依然面临着网络延迟高、CPU 开销大以及网络吞吐低的问题。

近年来，随着人工智能、分布式训练和分布式数据存储快速增长，对数据中心的网络延迟和吞吐要求越来越高。曾用于高性能计算领域的 RDMA 技术逐渐成为满足这些需求的首选解决方案。

RDMA（Remote Direct Memeory Access，远程直接内存访问）是一种绕过远程主机操作系统直接访问其内存的技术，其设计源自于 DMA 技术：
- 在 DMA 技术中，允许主机内部设备（如硬盘、网卡等）直接访问内存，中间不需要经过 CPU 的参与；
- RDMA 则是指主机之间的远程数据交换，也能像 DMA 那样，绕过远程主机操作系统以及 TCP/IP 协议栈，就像读取本地内存一样。

RDMA 的工作原理如图 3-10 所示，RDMA 绕过了传统以太网和主机内 TCP/IP 协议栈，应用直接通过网卡硬件就能与远程主机交互。由于不经过操作系统，大幅提升网络吞吐量的同时，还节省了大量 CPU 资源以及降低了网络通信延迟。

:::center
  ![](../assets/RDMA.png)<br/>
  图 3-10  RDMA 技术栈
:::

RDMA 网络主要由三种协议实现：Infiniband、RoCE 和 iWARP，它们的含义与区别如下：

- Infiniband（无限带宽）是一种专门为 RDMA 而生的技术，由 IBTA（InfiniBand Trade Association，
InfiniBand 贸易协会）在 2000 年提出。构建 Infiniband 网络需要配备全套专用设备，包括专用网卡、专用交换机和专用网线。付出高昂成本的收益是，Infiniband 网络能够实现小于 3 μs 时延和 400Gb/s 以上的网络吞吐。
	
	Infiniband 网络极致性能的背后，其实有着一系列缺陷：需要特定厂商提供的专用产品，封闭的技术架构也不兼容现有的以太网。因此，只有少数高性能计算领域会选择 Infiniband 网络。值得一提的是，风靡全球的人工智能应用 ChatGPT 背后的分布式机器学习系统就是基于 Infiniband 网络构建的。
- iWRAP（Internet Wide Area RDMA Protocol，互联网广域 RDMA 协议）是一种将 RDMA 封装在 TCP/IP 协议内的技术。iWRAP 存在先天设计缺陷，RDMA 技术为了高性能而生，而 TCP/IP 协议是为了可靠性而生，它的三次握手、拥塞控制等机制让 iWRAP 失去了绝大部分 RDMA 技术的优势。所以，iWRAP 已经逐渐被业界抛弃，笔者就不再介绍了。
- 为了降低 RDMA 使用成本，以及使 RDMA 技术走向通用数据中心领域。2010 年，IBTA 发布了 RoCE（RDMA over Converged Ethernet，融合以太网的远程直接内存访问）技术，将 Infiniband 的四层传输协议 RDMA“移植”到以太网。这样，只要有支持 RoCE 的特殊网卡 + 普通的以太网交换机就能享受 RDMA 高性能。如图 3-11 所示，RoCE 发展过程中出现了两个版本 RoCEv1 和 RoCEv2：
	- RoCEv1 是一种链路层协议，仅支持在二层网络内一个广播域内互通；
	- 而 RoCEv2 是一种网络层协议，允许不同广播域下的主机通过三层 IP 网络互通。

	RoCEv2 解除了 RoCEv2 无法跨子网的限制，同时结合本身固有的低成本以及兼容性优势，被广泛应用于分布式存储、分布式并行计算等通用数据中心场景。根据云计算平台 Azure 公开的信息，2023 年 Azure 整个数据中心 70% 的流量已经是 RDMA 流量了[^1]。
:::center
  ![](../assets/RoCE_Header_format.png)<br/>
  图 3-11 RoCE v1 只能在广播域内通信，RoCE v2 支持 L3 路由
:::

值得注意的是，RDMA 技术对网络丢包极为敏感，任何一个报文丢失都可能引发大量的重传，严重影响 RDMA 网络传输性能。Infiniband 网络依靠专用设备确保网络可靠性。而 RoCE 网络是在标准以太网基础设施上实现 RDMA 技术，这要求基础设施层面必须实现无损以太网，以避免丢包对网络性能产生严重影响。

目前，大多数数据中心使用 DCQCN（微软和 Mellanox 提出）以及 HPCC（阿里巴巴提出）算法为 RoCE 网络提供可靠性保障。由于这些算法涉及非常底层的技术（笔者的知识盲区），超出了本书的讨论范畴。笔者就不再详细介绍了，有兴趣的读者可以通过其他资料进一步了解相关内容。


[^1]: 参见 https://www.usenix.org/system/files/nsdi23-bai.pdf

