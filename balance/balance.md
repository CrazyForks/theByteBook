# 4.1 负载均衡概述

业内讨论网络负载均衡器的时候，负载均衡器（load balancer）和代理（proxy）两个术语经常无差别混用。本文继续沿用这种惯例，认为二者整体上是对等的。

:::tip 注意

严格来讲，不是所有代理都是负载均衡器， 但绝大部分代理的核心功能都包括负载均衡。
:::

图 4-1 展示了负载均衡的高层架构，客户端（Client）通过负载均衡器（Load Balancer）访问后端服务器（RealServer）。从整体架构来看，中间的负载均衡器承担下述职责：

- **服务发现**：识别系统中可用的后端服务器，并获取它们的地址，以便负载均衡器与后端通信。
- **健康检查**：确定哪些后端服务器处于健康状态并能够接收请求。
- **负载均衡**：基于适当的算法将请求均匀分配到健康的后端服务器上。

:::center
  ![](../assets/network-lb-overview.png)<br/>
 图 4-1 负载均衡高层架构图
:::

合理使用负载均衡能为分布式系统带来诸多好处：

- **命名抽象**：客户端通过预设机制（如 DNS 或内置库）访问负载均衡器，而无需了解后端服务器的拓扑结构或配置。
- **容错**：通过健康检查和多种负载均衡算法，将请求均匀转发至正常的后端服务器，故障服务器则会被移出负载均衡池，便于运维人员从容修复。
- **成本和性能收益**：分布式系统通常是异构的，后端服务器分布在多个网络区域（Zone/Region）。负载均衡器通过策略优先将请求保持在同一网络区域内，从而提高服务性能（减少延迟）并降低资源成本（减少跨区域带宽费用）。


若从网络层处理请求的层面看，所有的负载均衡可总结为两类：4 层负载均衡和 7 层负载均衡，两者字面上分别对应 OSI 模型的二层和七层。

## 4.1.1 四层负载均衡

需注意的是，所谓的“四层负载均衡”并不仅限于 OSI 模型的第四层（传输层）。实际上，四层负载均衡器的工作模式涉及多个网络层次：
- 在第二层（数据链路层），改写 MAC 地址实现请求转发；
- 在第三层（网络层），改写 IP 地址实现请求转发；
- 在第四层（传输层），修改 UDP 或 TCP 的端口和连接地址，以网络地址转换（NAT）的模式实现请求转发。

这些工作模式的特点在于它们都在某种程度上维持传输层协议（如 TCP、UDP）连接的特性。如果读者在某些资料中看到“二层负载均衡”或“三层负载均衡”的表述，应该理解这指的是它们在不同层次上的工作方式。

图 4-2 展示了四层负载均衡器的工作模型。客户端建立一个 TCP 连接，负载均衡器挑选一个后端，把来自客户端的 TCP 连接转发至后端。

:::center
  ![](../assets/balancer-4.svg)<br/>
 图 4-2 四层负载均衡器
:::

典型情况下，四层负载均衡器处理的是 TCP、UDP 这样的连接协议。保证属于同一 TCP/UDP connection/session 的字节永远落到同一后端。由于不感知其转发字节所属应用的任何细节，这些字节可能是 Web 应用、数据库服务或其他网络服务。因此，四层负均衡器有极其广泛的应用范围。

创建连接的开销很大（如 TCP 的三次握手，特别是在启用 TLS 加密时），大多数网络协议（如 TCP、HTTP/2、QUIC 和 WebSockets）在演进过程中支持多路复用（multiplexing）和连接保持（connection keep-alive）特性，以减少连接开销。四层负载均衡器为了实现“会话保持”，会将同一连接（connection）或会话（session）的字节流量始终转发至同一后端服务器。

仔细思考，上述的机制存在一个缺陷。以下是一个示例场景：

- 两个 HTTP2 客户端 A 和 B 通过四层负载均衡器和后端服务器建立连接。
- 四层负载均衡器为每个来自客户端的连接建立一个到后端服务器的连接，因此存在多个进来的连接和多个出去的连接。
- 客户端 A 的连接每分钟发送 40 个请求，而客户端 B 的连接每秒发送 1 个请求。

:::center
  ![](../assets/l4-connection.svg)<br/>
  图 四层负载均衡器“阻抗不匹配”问题
:::

上述的现象称为“阻抗不匹配”问题。

**四层均衡器为了实现“会话保持”，会根据哈希算法（如 IP 源地址哈希）将 A 客户端同一个 TCP 会话内的请求集中到某一台服务器上（图中的 RealServer1），这台服务器可能会异常繁忙，而其他服务器则处于闲置状态**。因此，随着用户规模的扩大，四层负载均衡器所面临的“阻抗不匹配”问题将变得愈发明显。

不过也不要担心，如计算机专家 David Wheeler 所言：

:::tip <a/> 

计算机科学中的所有问题都可以通过增加一个间接层来解决。如果不够，那就再加一层。

:::

在四层负载均衡器之后添加一个二级七层负载均衡器。首先，四层负载均衡器在传输层进行初步流量分发；随后，七层负载均衡器在应用层对请求进行更细化的分发，从而有效解决“阻抗不匹配”的问题。

## 4.1.2 七层负载均衡

因为数据已经被送至应用层，七层负载均衡的工作模式**只能通过建立新连接的方式将请求代理至**后端业务服务器。七层负载均衡的工作模式如图 4-13 所示。客户端与七层负载均衡器建立一个 HTTP/2 TCP 连接，七层负载均衡器和两个业务后端建立了两条独立的连接。

:::center
  ![](../assets/balancer7.svg)<br/>
  图 4-13 七层负载均衡器在客户端和后端服务器之间充当代理角色
:::

当七层负载均衡器发送两个 HTTP/2 请求（stream）时：
- 请求1（stream1）被代理至 RealServer1；
- 请求1（stream2） 被代理至 RealServer2。

七层负载均衡模式下，负载均衡器解析应用层内容，根据 URL、请求方法、Cookie 等应用层信息进行更精细的路由决策。因此，即使不同客户端的请求数量差异巨大，这些请求也可以被平衡代理至各个业务后端。之前提到的四层负载均衡“阻抗不匹配”问题，在七层代理模式下被妥善的解决了。

L7 负载均衡具备检测应用层流量的能力，尤其是在处理 HTTP 流量时，可以考虑以下子层级：

- 可选的 TLS（传输层安全性）：在网络领域，TLS 的归属层次尚存争议。为讨论的便利，本文假设其属于 L7。
- 物理 HTTP 协议：包括 HTTP/1 和 HTTP/2。
- 逻辑 HTTP 协议：涉及请求的头部、主体和尾部数据。
- 消息协议：例如 gRPC 和 REST 等。

高级的七层负载均衡器可能会提供与上述所有子层级相关的功能。这意味着，在比较负载均衡器的功能时，七层的复杂性远高于四层。



