# 4.2 负载均衡器特性


## 服务发现

服务发现是负载均衡器判断它有哪些可用后端的过程。服务发现实现的差异很大，以下是几种常见的例子：

- 静态配置文件：通过手动维护后端列表实现简单的服务发现。
- DNS：利用域名解析系统，动态地将服务请求路由到可用的后端服务器。
- Zookeeper、Etcd、Consul 等服务注册中心：通过这些分布式协调服务，管理和动态更新后端服务的注册信息。
- Envoy 的通用数据平面 API：提供一种标准化的数据平面接口，实现跨平台、跨环境的服务发现和负载均衡能力。

## 健康检查

判断后端是否能够接收请求的过程，主要分为两类：

- 主动健康检查：负载均衡器定期向后端发送健康探测（如向 /healthcheck 发送 HTTP 请求），通过响应状态来判断后端是否健康。
- 被动健康检查：负载均衡器通过实时数据流监测后端状态。例如，四层负载均衡器可能将三次连接错误视为不健康，七层负载均衡器可能将 503 错误码视为后端不健康的标志。

## 负载均衡

负载均衡解决的是：“给到一组健康的后端，选择谁来处理用户请求？”，也就是负载均衡器所采用的调度算法。

负载均衡调度算法是一个相对活跃的研究领域，从简单的随机选择，到更复杂的考虑各种延迟和后端负载状态的算法，笔者无法逐一展开，所以仅从功能和应用的角度简要介绍一些常见的负载均衡算法。

- **轮询均衡算法**（Round-Robin）：按依次循环的方式将请求调度到不同的服务器上，该算法最大的特点是实现简单。轮询算法假设所有的服务器处理请求的能力都一样，调度器会将所有的请求平均分配给每个真实服务器。

- **最小连接均衡算法**（Least-Connection）：该算法中调度器需要记录各个服务器已建立连接的数量，然后把新的连接请求分配到当前连接数最小的服务器。
	
	最小连接均衡算法特别适合于服务器处理时间不一致的场景。例如，当某些请求可能占用较长时间，而另一些请求很快就会完成时，最小连接算法可以有效避免某些服务器因处理大量复杂请求而过载。

- **一致性哈希均衡算法**（Consistency Hash）：将请求中的某些特征数据（例如 IP、MAC 或者更上层应用的某些信息）作为特征值来计算需要落在的节点。一致性哈希算法会保证同一个特征值的请求每一次都会落在相同的服务器上。

- **随机均衡算法**（Random）：此种负载均衡算法类似于轮询调度，不过在分配处理请求时是随机的过程。由概率论可以得知，随着客户端调用服务端的次数增多，其实际效果趋近于平均分配请求到服务端的每一台服务器，也就是达到轮询的效果。

以上算法假设的是所有服务器处理能力均相等，并不管服务器的负荷和响应速度。如果集群内各个服务器处理能力不一致呢？如服务器 A 每秒可处理 10 个请求，服务器 B 每秒可处理 100 个请求，不考虑服务器的处理能力的负载均衡算法，实际上是一种“伪均衡”算法。

考虑各个服务器的处理能力存在差异，负载均衡算法又有了对服务器“**加权**”的补充。

加权负载均衡算法增加了按权值高低分配的机制，权重较高的服务器处理更多的连接，从而保证服务器集群整体处于均衡状态。常用的加权负载均衡算法包括加权轮询（Weighted Round Robin）、加权最小连接（Weighted Least-Connection）和加权随机（Weighted Random）等，这里不再逐一介绍了。
