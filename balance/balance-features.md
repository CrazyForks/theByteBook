# 4.2 负载均衡器特性


现代负载均衡器承担的职责已经远远超出了最初的目标。本节简要介绍负载均衡器能做的事情，以便读者有个总体性的认识。

## 4.2.1 服务发现

服务发现是负载均衡器判断它有哪些可用后端的机制。不同系统实现服务发现的差异很大，以下是几种常见的实现方式：

- **静态配置文件**：通过手动维护后端列表实现最初级的服务发现。
- **DNS**：服务实例通过 SRV 记录或 A 记录注册到 DNS 服务器，客户端查询 DNS 记录获取服务的地址信息。
- **Zookeeper、Etcd、Consul 等服务注册中心**：服务实例在启动时向这些系统注册服务名称、地址、端口和健康检查信息。客户端通过相应的查询 API 获取服务信息。此类方案一般内置健康检查机制，能够定期检查服务实例的健康状态，并根据检查结果自动更新服务状态。
- **Envoy 的通用数据平面 API**：提供一种标准化的数据平面接口（xDS 协议），实现跨平台、跨环境的服务发现和负载均衡能力（参考本书第八章 8.3 节内容）。

## 4.2.2 健康检查

健康检查用于判断后端服务器是否能正常处理请求，目的是及时识别不可用的后端并重新分配流量。其机制主要分为主动检查和被动检查两类。

- **主动健康检查**：负载均衡器定期向后端发送健康探测，通过响应状态来判断后端是否健康。如，七层负载均衡器通过发送 HTTP 请求到特定的健康检查路径（如 /health 或 /status），判断 HTTP 状态码是否为 200 或其他预期的状态。
- **被动健康检查**：被动健康检查不需要负载均衡器主动发送探测请求，而是基于日常数据流监控后端服务器的状态。如，四层负载均衡中，如果在一定时间内发现某个后端出现多次连接失败、超时等异常，则负载均衡器可能标记该后端为不健康。七层负载均衡中，如果某个后端返回的 HTTP 状态码频繁出现错误（如 5xx 系列状态码），负载均衡器会视其为不健康。

## 4.2.3 粘性会话

对于某些特定应用，确保属于同一会话的请求被路由到相同的后端服务器至关重要。会话的定义因应用而异，可能包括 HTTP cookies、客户端连接特性或其他相关属性。大部分的七层负载均衡器，支持配置 HTTP cookies 或 IP 哈希实现粘性会话（sticky session）。

需要注意的是，粘性会话涉及缓存和复杂的临时状态管理，它的设计本质上是脆弱的（赖于特定服务器、无法动态扩展、不可预测的负载分配问题等），一旦处理会话的后端出现故障，整个机制可能会受到影响。因此，设计依赖于该特性的系统时，需要格外谨慎。

## 4.2.4 TLS 卸载

TLS 卸载（TLS Termination）指将 TLS 的加密/解密、证书管理等操作，由负载均衡器进行统一收敛处理。这样的好处是：
- **减轻后端负载**：后端服务器无需处理加密/解密操作，可以专注于业务逻辑处理。
- **减少运维负担**：负载均衡器统一管理 SSL 证书的配置和更新，避免每个后端服务器单独管理证书。
- **提升请求效率**：负载均衡器通常具有强大的硬件加速能力，经过了大量调优，可以快速处理 TLS 连接，从而降低 HTTPS 请求延迟（参考本书第二章 2.5.2 节内容）。

## 4.2.5 安全和 DDoS 防御

负载均衡器可以实现 IP 黑/白名单、请求限速和鉴权等功能。根据 IP 的访问流量实现 QoS 控制，保证高优先级请求的响应时间，同时限制低优先级请求的频率，确保系统资源得到合理分配。

此外，通过稍后介绍的边缘代理的拓扑，即不同地理位置部署多个边缘代理，在靠近用户的位置分散流量，不仅能减少延迟，而且对于防御 DDos 攻击尤其有效。


## 4.2.6 可观测性

网络本质上是不可靠的，负载均衡器通常需要导出请求统计、跟踪和日志等信息，以帮助运维人员识别和修复问题。

负载均衡器输出的可观测性数据差异很大，从基本的统计信息（如流量、连接数和错误率）到与微服务架构集成的调用链追踪，功能各异：

- 四层负载均衡器的可观测性数据主要集中在连接、流量、错误、延迟等网络层面的统计。
- 七层负载均衡器则能够提供更为丰富的应用层数据，包括 HTTP 请求的详细分析、错误码、会话保持、路由分配、用户行为分析等。

需要注意的是，支持可观测性并非没有代价，负载均衡器需要进行额外处理来生成这些数据，但所带来的收益远超过由此引起的性能损失。

## 4.2.7 负载均衡

负载均衡解决的是：“给到一组健康的后端，选择谁来处理用户请求？”，也就是负载均衡器所采用的调度算法。

负载均衡调度算法是一个相对活跃的研究领域，从简单的随机选择，到更复杂的考虑各种延迟和后端负载状态的算法，笔者无法逐一展开，这里仅从功能和应用的角度简要介绍一些常见的负载均衡算法。

- **轮询均衡算法**（Round-Robin）：按依次循环的方式将请求调度到不同的服务器上，该算法最大的特点是实现简单。轮询算法假设所有的服务器处理请求的能力都一样，调度器会将所有的请求平均分配给每个真实服务器。

- **最小连接均衡算法**（Least-Connection）：该算法中调度器需要记录各个服务器已建立连接的数量，然后把新的连接请求分配到当前连接数最小的服务器。
	
	最小连接均衡算法特别适合于服务器处理时间不一致的场景。例如，当某些请求可能占用较长时间，而另一些请求很快就会完成时，最小连接算法可以有效避免某些服务器因处理大量复杂请求而过载。

- **一致性哈希均衡算法**（Consistency Hash）：将请求中的某些特征数据（例如 IP、MAC 或者更上层应用的某些信息）作为特征值来计算需要落在的节点。一致性哈希算法会保证同一个特征值的请求每一次都会落在相同的服务器上。

- **随机均衡算法**（Random）：此种负载均衡算法类似于轮询调度，不过在分配处理请求时是随机的过程。由概率论可以得知，随着客户端调用服务端的次数增多，其实际效果趋近于平均分配请求到服务端的每一台服务器，也就是达到轮询的效果。

以上算法假设的是所有服务器处理能力均相等，并不管服务器的负荷和响应速度。如果集群内各个服务器处理能力不一致呢？如服务器 A 每秒可处理 10 个请求，服务器 B 每秒可处理 100 个请求，不考虑服务器的处理能力的负载均衡算法，实际上是一种“伪均衡”算法。

考虑各个服务器的处理能力存在差异，负载均衡算法又有了对服务器“**加权**”的补充。

加权负载均衡算法增加了按权值高低分配的机制，权重较高的服务器处理更多的连接，从而保证服务器集群整体处于均衡状态。常用的加权负载均衡算法包括加权轮询（Weighted Round Robin）、加权最小连接（Weighted Least-Connection）和加权随机（Weighted Random）等，这里不再逐一介绍了。
