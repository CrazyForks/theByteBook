# 4.4 七层负载均衡 

前面介绍的四层负载均衡实际上是通过 IP 和端口的组合进行流量转发，**客户端、四层负载均衡器及后端真实服务器之间维持同一条传输层（TCP 或 UDP）通道**。七层负载均衡的工作模式就无法进行流量转发了。

因为数据已经被送至用户空间，七层负载均衡的工作模式**只能通过建立新连接的方式将请求代理至**后端业务服务器。七层负载均衡的工作模式如图 4-13 所示。客户端与七层负载均衡器建立一个 HTTP/2 TCP 连接，七层负载均衡器和两个业务后端建立了两条独立的连接。

:::center
  ![](../assets/balancer7.svg)<br/>
  图 4-13 七层负载均衡器在客户端和后端服务器之间充当代理角色
:::

当七层负载均衡器发送两个 HTTP/2 请求（stream）时：
- 请求1（stream1）被代理至 RealServer1；
- 请求1（stream2） 被代理至 RealServer2。

七层负载均衡模式下，负载均衡器解析应用层内容，根据 URL、请求方法、Cookie 等应用层信息进行更精细的路由决策。因此，即使不同客户端的请求数量差异巨大，这些请求也可以被平衡代理至各个业务后端。之前提到的四层负载均衡“阻抗不匹配”问题，在七层代理模式下被妥善的解决了。


早期的七层负载均衡，仅仅实现应用层请求的代理。如果把非业务功能，如路由请求、鉴权、监控、缓存、限流和日志记录等集中在一层处理，并在一个控制台统一管理，这就是七层负载均衡的升级 —— **网关（API Gateway）**。

目前，业界已经出现了非常多的开源网关解决方案。根据实现语言以及应用场景来说，主流方案如表4-1所示。

:::center
表 4-1 业内网关代表方案
::: 
网关|特点|
|:--|:--|
OpenResty| 基于 Nginx 和 LuaJIT 的高性能 Web 平台。通过 LuaJIT 引擎，OpenResty 允许用户在 Nginx 中编写 Lua 脚本。这使得开发者可以在请求处理的不同阶段（如请求、响应、重写、日志等）动态地执行自定义逻辑 ，快速构造出足以胜任 10K 乃至 1000K 以上单机并发连接的高性能 Web 应用系统。|
|Kong| 社区活跃、成熟度高、Postgres 存储、二次开发成本高 |
|Spring Cloud Gateway| Spring Cloud Gateway 是 Spring 生态系统中的一个网关解决方案，适用于 SpringBoot 和 SpringCloud 构建的微服务系统|
|Traefik| Docker、Kubernetes 等容器编排系统紧密结合。 |
|Envoy | Envoy 是 Lyft 开发的一款面向服务网格的高性能网络代理，支持高级的路由控制、负载均衡策略、服务发现和健康检查等。Envoy 与 Istio 等服务网格解决方案紧密结合，通常作为它们的数据平面代理使用。|

这些现代化的网关方案各有各的特点，实现的功能也非常强大，笔者就不再一介绍，简单列举部分网关功能，以便读者对“强大功能”有个直观的感受。

- **协议支持**：网关对应用层协议了解的越多，就可以处理更复杂的事情。如系统可观测、高级负载均衡和路由等。云原生网关的典型代表 Envoy 支持如下七层协议的解析和路由：HTTP/1、HTTP/2、gRPC、Redis、MongoDB、DynamoDB 等等。

- **动态配置**： 服务管理的动态配置包括路由、上游服务（Upstream）、SSL证书、消费者等等，数据的替换和更新不会产生任何中断，从而将线上流量的影响降低到最低。

- **流量治理**：很多微服务架构中，流量治理都需要在七层中进行，譬如超时、重试、限速、熔断、流量镜像、缓存等等。现代网关系统在服务以及流量的管理上可对多业务进行收敛统一处理，降低多套网关的运维成本。

- **可观测性**：互联网快速发展的今天，基础设施与应用的部署构建都发生了极大变化，特别是基于分布式、微服务的体系架构，传统的监控方式已经无法适应云原生的场景。服务治理的可观测性输出是网关系统提供的最重要的特性。系统度量、分布式跟踪以及自定义日志等功能现在几乎是七层负载均衡解决方案的标配。需要指出的是，丰富的可观测数据并不是没有代价的，负载均衡器需要做一些额外的工作才能产生这些数据。但是，这些数据带来的收益要远远大于为产生它们而增加的那点性能损失。

- **可扩展性**：例如典型网关 OpenResty，通过编写可插拔的插件能够轻松地对网关系统实现各种流量处理以及各类自定义功能，譬如流量限速、日志记录、安全检测、故障注入等等。

- **高可用以及无状态设计**：现代网关系统不仅提供数据面实现，还提供控制面实现，二者目标都在朝向无状态设计，可以轻松地实现水平扩展。网关架构整体上也默认高可用，不存在单点故障。





至此，我们已经了解了四层负载均衡与七层负载均衡在处理请求层面上的区别。我们再根据表 4-2，从更多层面建立一个总体的印象。

:::center
表 4-2 业内网关代表方案
::: 

|特性|四层负载均衡（L4）|七层负载均衡（L7）|
|:--|:--|:--|
|工作层次|传输层（TCP/UDP）|应用层（HTTP/HTTPS）|
|处理速度	|较快（低延迟）	|相对较慢（增加了处理开销）|
|灵活性|较低，基于 IP 和端口进行路由|高，基于内容、请求头等进行路由|
|功能|主要实现流量分发|支持内容缓存、内容路由、SSL 终止（SSL Termination）等高级功能|
|适用场景|实时应用、简单的 TCP/UDP 服务|Web 应用、微服务架构、复杂请求处理|


业内通常采用多级混合负载均衡的方式部署，也就是底层负载均衡在前，高级负载均衡在后：
- 两者分工明确：四层负载均衡器工作在更低的协议层，能够更快地处理请求。七层负载均衡器工作高协议层，能够根据更复杂的业务逻辑进行请求处理。
- 加强容错能力：七层负载均衡功能复杂且部署频繁，因此更容易出现 bug。在七层负载均衡之前添加一层四层负载均衡，进行健康检查和流量排除，这比单独依赖某一层负载均衡要可靠得多。


