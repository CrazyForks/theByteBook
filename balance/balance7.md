# 4.4 七层负载均衡 

四层负载均衡的工作模式属于“转发”，客户端与响应请求的真实服务器维持着同一条 TCP 通道，但七层的负载均衡模式就无法再转发了。

:::tip <a/>
七层指的是类似 HTTP 这样的应用层协议，那就要把 TCP 数据传送到用户态中的程序处理，之后再用代理的方式新建一个请求到真实服务器。
:::

如图 4-13 所示，一个七层 HTTP/2 负载均衡器，此时客户端（client）、负载均衡器（Load Balancer）、业务服务器（RealServer）的工作模式。
:::center
  ![](../assets/balancer7.svg)<br/>
  图 4-13 七层负载均衡工作模式
:::

此时，客户端与七层负载均衡器建立一个 HTTP/2 TCP 连接，负载均衡器根据负载均衡策略和两个业务后端建立了连接。当客户端向负载均衡器发送两个 HTTP/2 stream 时：
- stream1 会被发送到 RealServer1；
- stream2 会被发送到 RealServer2。

因此，即使不同客户端的请求数量差异巨大，这些请求也可以被平衡到各个业务后端。因为七层负载均衡具备检测应用层流量的能力，所以做出更多、更明智的决策，也能玩出更多的花样。

七层负载均衡的能力更强，那是否意味着四层负载均衡已经没用了？肯定不，几乎所有的现代大型分布式系统都使用 L4/L7 两级部署的原因是：

- 两者分工明确：四层负载均衡器可以在前端快速处理大量请求，进行初步的流量分发（SYN 泛洪、通用包泛洪攻击），而七层负载均衡器则可以在后端进行更精细的流量管理和处理（如 SSL 卸载、请求重写、缓存、内容路由）。

- 容错：七层负载均衡的部署更为广泛且频繁，因此更容易出现 bug。在七层负载均衡之前添加一层四层负载均衡，可以在调整七层负载均衡配置时进行健康检查和流量排除，这比单独依赖四层负载均衡要可靠得多。