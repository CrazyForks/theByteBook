# 4.3.3 四层负载均衡小结

四层负载均衡器不会感知转发字节所属于的具体应用。这些字节可能来自于 Web 应用、数据库服务或其他网络服务。因此，四层负载均衡器“支持”所有的网络协议，具有广泛的应用范围。

由于创建连接的开销较大（例如，TCP 需要经过三次握手），特别是在使用 TLS 加密的情况下。因此，几乎所有的网络协议，如 TCP、HTTP/2、QUIC 和 WebSockets，在演进过程中都开始支持多路复用（multiplexing）和连接保持（connection keep-alive）特性，以降低网络连接的开销。但四层负载均衡器为了实现“会话保持”，会将同一连接（connection）或会话（session）的字节流量始终转发至同一后端服务器。

仔细思考，四层负载均衡器存在一个明显的缺陷，以下是一个示例场景：

- 两个 HTTP2 客户端 A 和 B 通过四层负载均衡器和后端服务器建立连接。
- 四层负载均衡器为每个来自客户端的连接建立一个到后端服务器的连接，因此存在多个进来的连接和多个出去的连接。
- 客户端 A 的连接每分钟发送 1 个请求，而客户端 B 的连接每秒发送 50 个请求。

上述的现象称为“阻抗不匹配”问题。**四层均衡器为了实现“会话保持”，会利用哈希算法会将 B 客户端同一个 TCP 会话内的请求集中到某一台服务器上，那么这台服务器可能会异常繁忙，而其他服务器则处于闲置状态**。因此，随着用户规模的扩大，四层负载均衡器所面临的“阻抗不匹配”问题将变得愈发明显。

不过也不要担心，如计算机专家 David Wheeler 所说：

:::tip <a/> 

计算机科学中的所有问题都可以通过增加一个间接层来解决。如果不够，那就再加一层。

:::

四层负载均衡之后面加一级七层负载均衡：传输层进行初步的流量分发，在应用层对请求进行进一步路由到不同后端服务器。便可有效解决“阻抗不匹配”的问题。
